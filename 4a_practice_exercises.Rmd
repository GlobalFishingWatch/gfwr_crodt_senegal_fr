---
title: "4A. gfwr Practice Exercise (gfw_ais_presence)"
output: 
  html_document:
     code_folding: hide
date: "2025-10-22"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  #echo = FALSE,       # hide code by default
  warning = FALSE,    # hide warnings
  message = FALSE,    # hide messages
  error = FALSE       # stop knitting on error
)

# pour charger les packages
library(gfwr)
library(tidyr)
library(dplyr)

# Mapping libraries
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(tmap)

```

## Problem

1.  Create maps of vessel presence for SEN-flagged versus foreign-flagged fishing vessels for 2024 inside the given shapefile. Compare with low versus high spatial resolution of vessel presence.
2.  Using the high spatial resolution vessel presence data, create a set of maps comparing vessel presence per year for foreign-flagged versus SEN-flagged (all) vessels from 2021 to 2024.

## Workflow

1.  First, let's read the shapefile we will use to get vessel presence.

```{r read_shapefile}
# Get the polygon shapefile
offshore_area <- st_read(here::here("data","Shapefiles","Cayr_Profond","Cayar_Offshore_Profond.shp"))
```

2.  Next, let's pull the vessel presence data for two resolutions: LOW (0.1 degree bins) and HIGH (0.01 degree bins). Filter only for `vessel_type = 'fishing'`.

```{r get_ais_presence}
# Get the polygon shapefile
ais_presence_low <- gfw_ais_presence(spatial_resolution = 'LOW',
                                 temporal_resolution = 'YEARLY',
                                 start_date = '2024-01-01',
                                 end_date = '2025-01-01',
                                 region_source = 'USER_SHAPEFILE',
                                 group_by = 'VESSEL_ID',
                                 filter_by = "vessel_type = 'fishing'",
                                 region = offshore_area)

ais_presence_high <- gfw_ais_presence(spatial_resolution = 'HIGH',
                                 temporal_resolution = 'YEARLY',
                                 start_date = '2024-01-01',
                                 end_date = '2025-01-01',
                                 region_source = 'USER_SHAPEFILE',
                                 group_by = 'VESSEL_ID',
                                 filter_by = "vessel_type = 'fishing'",
                                 region = offshore_area)



```

2.  Let's summarize into a dataframe of total presence hours so we can create four heatmaps of vessel presence hours comparing LOW and HIGH resolution data and also domestic versus foreign vessels. To identify domestic vessels, we can create a new field "group" that will have a value of "domestic" if the vessel flag is "SEN" and "foreign-flagged" if flag is not equal to "SEN".

```{r}
# Summarize total hours by lat-lon combination
ais_presence_df <-
  ais_presence_low %>%
  mutate(group = if_else(Flag != "SEN" | is.na(Flag),"foreign","domestic"),
         resolution = "LOW") %>%
  # Add the HIGH resolution data using bind_rows
  bind_rows(
    ais_presence_high %>%
      mutate(group = if_else(Flag != "SEN" | is.na(Flag),"foreign","domestic"),
             resolution = "HIGH") 
  ) %>%
  group_by(Lat,Lon,group, resolution) |>
  summarize(hours = sum(`Vessel Presence Hours`,na.rm=T))

```

3.  Next would be to create a heatmap using `ggplot2`. It's good practice to define the theme and elements before plotting the map so these could be re-used.

```{r}
# Map theme with dark background
map_theme <- ggplot2::theme_minimal() +
  ggplot2::theme(
    panel.border = element_blank(),
    legend.position = "bottom", legend.box = "vertical",
    legend.key.height = unit(3, "mm"),
    legend.key.width = unit(20, "mm"),
    legend.text = element_text(color = "#848b9b", size = 8),
    legend.title = element_text(face = "bold", color = "#363c4c", size = 8, hjust = 0.5),
    plot.title = element_text(face = "bold", color = "#363c4c", size = 10),
    plot.subtitle = element_text(color = "#363c4c", size = 10),
    axis.title = element_blank(),
    axis.text = element_text(color = "#848b9b", size = 6)
  )

# Paleta para as cores de atividade
map_presence_light <- c("#ffffff", "#00ffc3", "#114685", "#0c276c")

# Set a buffer to the data for plotting extent
map_buffer_degrees <- 0.5

```

4.  Now let's plot the maps using `ggplot2` and overlay also the polygon file we used.

```{r}
# Compare the map of Vessel Presence hours with LOW and HIGH resolution data
ais_presence_df %>%
  filter(hours > 0) %>%
  ggplot() +
  geom_tile(aes(x = Lon,
                  y = Lat,
                  fill = hours),
            col = scales::alpha("grey90", 0.3)) +
  geom_sf(data = ne_countries(returnclass = "sf", scale = "medium")) +
  geom_sf(data = offshore_area, fill = NA, color = "red", linewidth = 0.8) +
  coord_sf(xlim = range(ais_presence_df$Lon) +
             c(-map_buffer_degrees,map_buffer_degrees),
           ylim = range(ais_presence_df$Lat) + 
             c(-map_buffer_degrees,map_buffer_degrees)) +
  scale_fill_gradientn(
    trans = 'log10',
    colors = map_presence_light,
    na.value = NA,
    labels = scales::comma) +
  labs(title = "Vessel presence hours at different spatial resolutions",
       subtitle = "2024-01-01 to 2025-01-01",
       fill = "AIS presence hours") +
  facet_grid(group~resolution) +
  map_theme
```

4.  Next, let's create the annual vessel presence maps from 2021 to 2024 for domestic versus foreign-flagged vessels using high resolution vessel presence data. Since there is a 1-year limit to the data that can be retrieved using `gfw_ais_presence()`, we need to create a loop to download the data per year and then combine them into one dataframe.

```{r}
# We will use the package purrr to create a loop

library(purrr)

years <- 2021:2024


ais_presence_list <- map(years, function(y) {
  start <- paste0(y, "-01-01")
  end   <- paste0(y + 1, "-01-01")
  
  gfw_ais_presence(
    spatial_resolution = 'HIGH',
    temporal_resolution = 'YEARLY',
    start_date = start,
    end_date = end,
    region_source = 'USER_SHAPEFILE',
    group_by = 'VESSEL_ID',
    filter_by = "vessel_type = 'fishing'",
    region = offshore_area
  ) %>%
    # add a column "year" to each output
  mutate(year = y)
})

# collapse list into one dataframe with a 'year' column
ais_presence_annual <- map2_dfr(ais_presence_list, years, ~ mutate(.x, year = .y))
```

5.  Now we can create a summary data frame of Lat, Lon, Group, year, and total presence hours and use this to create a facet grid map by group and year.

```{r}
ais_presence_annual_df <-
  ais_presence_annual %>% 
  mutate(group = if_else(Flag != "SEN" | is.na(Flag),"foreign","domestic")) %>%
  group_by(Lat,Lon,group,year) %>%
  summarize(hours = sum(`Vessel Presence Hours`,na.rm=T))

ais_presence_annual_df %>%
  ggplot() +
  geom_tile(aes(x = Lon,
                  y = Lat,
                  fill = hours),
            col = scales::alpha("grey90", 0.3)) +
  geom_sf(data = ne_countries(returnclass = "sf", scale = "medium")) +
  geom_sf(data = offshore_area, fill = NA, color = "red", linewidth = 0.8) +
  coord_sf(xlim = range(ais_presence_annual_df$Lon) +
             c(-map_buffer_degrees,map_buffer_degrees),
           ylim = range(ais_presence_annual_df$Lat) + 
             c(-map_buffer_degrees,map_buffer_degrees)) +
  scale_fill_gradientn(
    trans = 'log10',
    colors = map_presence_light,
    na.value = NA,
    labels = scales::comma) +
  labs(title = "Vessel presence hours by year for domestic vs foreign-flagged vessels",
       #subtitle = "2024-01-01 to 2025-01-01",
       fill = "AIS presence hours") +
  facet_grid(group~year) +
  map_theme


```
